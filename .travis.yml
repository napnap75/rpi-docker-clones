language: bash
services: docker
sudo: required

env:
  - SOURCE_REPO=https://github.com/kylemanna/docker-openvpn BASE_IMAGE=arm32v6/alpine:latest DEST_REPO=napnap75/rpi-openvpn
  
install:
  - docker run --rm --privileged multiarch/qemu-user-static:register
  
script:
  - mkdir source
  - git clone ${SOURCE_REPO} source
  - cd source
  - sed -i "/FROM .*/a ADD qemu-arm-static /usr/bin" Dockerfile
  - sed -i "s#FROM .*#FROM ${BASE_IMAGE}#" Dockerfile
  - cat Dockerfile
  - curl -L -o qemu-arm-static.tar.gz https://github.com/multiarch/qemu-user-static/releases/download/v2.6.0/qemu-arm-static.tar.gz && tar zx -f qemu-arm-static.tar.gz
  - docker build -t ${DEST_REPO}:latest .
    
after_success:
  - if [ "$TRAVIS_BRANCH" == "master" ]; then
      docker login -u="$DOCKER_USERNAME" -p="$DOCKER_PASSWORD" ;
      docker push ${DEST_REPO}:latest ;
    fi
